@using Whiskey.ZeroStore.ERP.Transfers
@using System.Collections
<style>
    .dataTables_filter {
        display: none !important;
    }

    .disable_all_conte {
        position: relative;
        z-index: 1025;
        opacity: 0.3 !important;
        background-color: black !important;
        cursor: not-allowed;
    }

    .disable_all_aOrlab {
        cursor: not-allowed;
    }

    .modal-dialog {
        width: 760px;
        margin: 30px auto;
    }
    .img-thumbnail {
        width:80px;
    }
   .purchase-date{
   	width: 100% !important;
   }
</style>
<div class="row">
    <div class="col-md-7">
        <div id="left_content" title="请选择右侧的下拉菜单以激活当前区域">
            <div class="panel panel-primary panel-dark widget-profile">
                <div class="panel-heading">
                    <div class="widget-profile-bg-icon"></div>
                    <div class="widget-profile-header text-center">
                        <h3>请使用扫码枪将商品货号扫入下边文本框</h3>
                    </div>
                </div>
                <div class="list-group-item no-border-hr clearfix valign-middle">
                    <div>
                        @* <div class="col-md-3"></div>*@
                        <div class="" style="padding-left:0;margin-bottom:10px">
                            @Html.TextBox("ScanNumber", "", new { @placeholder = "", @class = "scan-number  text-center input-lg form-control", @style = "ime-mode:disabled;margin-top:15px;display:inline;width:75%;height:30%", @onkeyup = "this.value=this.value.toUpperCase().replace(/[\u4e00-\u9fa5]/g,'')" })
                            <input id="sear-ok" class="input-lg form-control" style="display:inline;width:16%;margin-left:auto" type="button" value=">>" />
                        </div>
                        <div class="col-md-3"></div>
                        <div>
                            <input class="form-control" id="selec_prod_list" type="button" value="选择商品……" style="font-weight: bold;" />
                            <input class="form-control" id="selec_prodBatch_list" type="button" value="批量导入……" style="font-weight: bold;" />

                        </div>
                    </div>
                </div>

                <div class="widget-profile-counters clearfix">
                    <div class="col-xs-4"><label class="label label-info scan-queue-count">0</label><br />队列数量</div>
                    <div class="col-xs-4"><a href="javascript:void(0);" class="scan-valid"><label class="label label-success scan-valid-count">@ViewBag.ScanValidCount</label><br />有效数量</a></div>
                    <div class="col-xs-4"><a href="javascript:void(0);" class="scan-invalid"><label class="label label-danger scan-invalid-count">@ViewBag.ScanInvalidCount</label><br />无效数量</a> </div>

                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="hid_da_pur" value="@ViewBag._purnum" />
    <div class="col-md-5">
        <div class="stat-panel">
            <div class="stat-row">
                <div class="stat-cell padding-sm-hr bordered valign-top" style="padding-bottom:0">
                    <ul class="list-group no-margin" style="margin-bottom: 0;">
                        <li class="list-group-item no-border-hr no-border-t padding-xs-vr no-bg no-border-radius clearfix">
                            <label class="control-label col-md-4">出货仓库</label>
                            <div class="col-md-8">
                                @Html.DropDownList("StorageId", (List<SelectListItem>)ViewBag.Storages, new { @class = "form-control receive-store cur_selectpicker" })
                            </div>
                        </li>
                        <li class="list-group-item no-border-hr no-border-t padding-xs-vr no-bg no-border-radius clearfix">
                            <label class="control-label col-md-4">购入店铺</label>
                            <div class="col-md-8">
                                <select id="StoreID" name="StoreID" class="form-control receive-store"></select>
                            </div>
                        </li>
                        <li class="list-group-item no-border-hr no-border-t padding-xs-vr no-bg no-border-radius clearfix">
                            <label class="control-label col-md-4">采购入库</label>
                            <div class="col-md-8">
                                @Html.DropDownList("BuyStorageID", (List<SelectListItem>)ViewBag.inStorage, new { @class = "form-control receive-store cur_selectpicker" })
                            </div>
                        </li>


                        <li class="list-group-item no-border-hr no-border-t padding-xs-vr no-bg no-border-radius clearfix">
                            <label class="control-label col-md-4">采购日期</label>
                            <div class="col-md-8">
                                <div class="input-group date purchase-date">
                                    @Html.TextBox("CreateTime", "", new { @class = "form-control", @placeholder = DateTime.Now.ToString("yyyy年MM月dd日"), @style = "font-size:12px;" })
                                    <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
                                </div>
                            </div>
                        </li>

                        <li class="list-group-item no-border-hr no-border-t padding-xs-vr no-bg no-border-radius clearfix">
                            <label class="control-label col-md-4">备注信息</label>
                            <div class="col-md-8">
                                @Html.TextBox("Notes", "", new { @class = "form-control" })
                            </div>
                        </li>

                        <li class="list-group-item no-border-hr no-border-b padding-xs-vr no-bg no-border-radius clearfix">
                            <div>
                                <button id="Create" type="button" class="btn btn-success  btn-padding-right" disabled><i class="fa fa-arrow-right"></i> 配货完成</button>
                                <button id="Save" type="button" class="btn btn-success  btn-padding-right"><i class="fa fa-arrow-left" style="padding: 0 3px;"></i>保存返回</button>
                                @*<button id="RemoveAll" type="button" class="btn btn-danger btn-padding-right"><i class="fa fa-trash"></i> 移除所选商品</button>*@
                            </div>
                        </li>

                    </ul>
                </div>
            </div>
        </div>

    </div>
    <div class="col-md-12">
        <div class="panel  panel-list">
            <div class="panel-heading">
                <div class="panel-title">
                    <h5><i class="fa fa-list"></i> 已选择的商品</h5>
                </div>
                <span class="text-right list-info"></span>
            </div>
            <div>
                <table class="table table-list table-hover valign-middle" width="100%">
                    <thead>
                    </thead>
                </table>
            </div>
        </div>
    </div>

</div>
<script>
    @*@if(ViewBag._purnum!=""){
      @section ModuleName{修改采购单}
    }
    else{
      @section ModuleName{创建采购单}
    }*@
</script>

@section Scripts{
    <script src="~/Content/Scripts/Common/comm.js"></script>
    <script type="text/javascript">
        var hashlist = new $.whiskey.hashtable();
        var _guid = $.whiskey.tools.UUID();
        $(function () {
            $("#StoreID").queryManageStore({ selected: "@ViewBag.InStoreId" });
            $("#CreateTime").datepicker();

            $.whiskey.datatable.instance = $(".table-list").dataTable({
                "sAjaxSource": "@Url.Action("ValidList")",
                "aaSorting": [[0, 'desc']],
                "sDom": 't<"F clearfix datatable-footer"<"col-md-2"l>r<"col-md-3"f><"col-md-7 text-right"p>>',
                "fnServerParams": function (aoData) {

                    aoData.push({ name: "uuid", value: _guid });
                },
                "aoColumns": [
                    {
                        "sTitle": $.whiskey.datatable.tplTitleCheckbox(),
                        "bSortable": false,
                        "bSearchable": false,
                        "sName": "Id",
                        "mData": function (da) {
                            return $.whiskey.datatable.tplListCheckbox(da.Id);
                        }

                    },
                    {
                        "sTitle": "编号",
                        "bSortable": false,
                        "sName": "num",
                        "AutoIncrement": false,
                        "mData": function (da) {
                            return "";
                        }

                    },
                    {
                        "sTitle": "商品款号",
                        "bSortable": false,
                        "sName": "ProductNumber",
                        "AutoIncrement": false,
                        "mData": function (da) {
                            return da.ProductNumber;
                        }

                    },
                    {
                        "sTitle": "品牌",
                        "bSortable": false,
                        "sName": "Brand",
                        "mData": function (da) {
                            return da.Brand;

                        }

                    },
                    {
                        "sTitle": "品类",
                        "bSortable": false,
                        "sName": "Category",
                        "mData": function (da) {
                            return da.Category;

                        }

                    },
                    {
                        "sTitle": "尺码",
                        "bSortable": false,
                        "sName": "Size",
                        "mData": function (da) {
                            return da.Size;
                        }
                    },
                    {
                        "sTitle": "季节",
                        "bSortable": false,
                        "sName": "Season",
                        "mData": function (da) {
                            return da.Season;
                        }
                    },
                    {
                        "sTitle": "颜色",
                        "bSortable": false,
                        "sName": "Color",
                        "mData": function (da) {
                            return da.Color;
                        }
                    },
                     {
                         "sTitle": "数量（已配 / 总数）",
                         "bSortable": false,
                         "sName": "Quantity",
                         "mData": function (da) {
                             var PurchaseQuantity = da.PurchaseQuantity;
                             var str = "（" + PurchaseQuantity + " / " + da.Quantity + "）";
                             if (PurchaseQuantity != da.Quantity) {
                                 str = "<label style='color:#e66454;font-weight:bold;'>" + str + "</label>";
                             }
                             return str;
                         }
                     },
                    {
                        "sTitle": "来源",
                        "sName": "IsNewAdded",
                        "bSortable": false,
                        "bSearchable": false,
                        "mData": function (da) {
                            return $.whiskey.datatable.lblColor(da.IsNewAdded ? "仓库" : "用户", da.IsNewAdded ? "success" : "");
                        }
                    },
                    {
                        "sTitle": "图片",
                        "sName": "Thumbnail",
                        "bSortable": false,
                        "bSearchable": false,
                        "mData": function (da) {
                          // return "<img style='float:center' class='img-thumbnail img-responsive' src=" + da.Thumbnail + ">";
                             return '<div class="thumbnail-img_five_box"><div class="thumbnail-img_five"><div class="thumbnail-img_f" onclick="showPath(this)"><img class="popimg" src="' + da.Thumbnail + '" /></div></div></div>';
                            
                        }
                    },
                    {
                        "sTitle": "操作",
                        "bSortable": false,
                        "bSearchable": false,
                        "mData": function (data) {
                            return $.whiskey.datatable.tplReset(data.Id);
                        }
                    }
                ]

            });

            //$(".scan-number").blur(function () {
            //    $(this).addClass("input-validation-error");
            //}).focus(function () {
            //    $(this).removeClass("input-validation-error");
            //});

            $(".scan-number").keyup(function (event) {
                if (event.keyCode == 13) {
                    var scanNumber = $(this).val().trim();
                    if (scanNumber.length > 0) {
                        var barcodeArr = scanNumber.split(',');
                        if (barcodeArr.length <= 0) {
                            return;
                        }
                        barcodeArr.forEach(function (value, index, arr) {
                            var uuid = $.whiskey.tools.UUID(32, 16);
                            hashlist.put(uuid, value);
                        });
                        $(".scan-queue-count").text(hashlist.size());
                        $(".scan-number").val("");
                        $(".scan-number").focus();

                    }

                }
            }).focus();

            $("#Save").click(function () {
                $.whiskey.web.load({
                    url: "/Warehouses/Purchase/Index",
                });
            });

        });

        function Reset(sender, id) {
            var PurchaseNumber = $("#hid_da_pur").val();
            var confirm = new $.whiskey.web.ajaxConfirm({
                question: "确认要重置该商品吗？",
                notes: "提示：此操作会将会重置选择的商品并解锁库存",
                actionUrl: "@Url.Action("Remove")",
                params: { ids: [id], uuid: _guid, PurchaseNumber: PurchaseNumber },
                lockButton: $(sender),
                complete: function (data) {
                    $.whiskey.datatable.reset(true);
                    getValidAndInvalidCount();
                }
            });
        }
    </script>

    <script>
        $(function() {

            getValidAndInvalidCount();

            //禁用扫描框
            allDisabled();
            //启用扫描框
            $(".col-md-8").click(function() {
                var outstorage = $("#StorageId option:selected").val();
                var store = $("#StoreID option:selected").val();
                var buyStorage = $("#BuyStorageID option:selected").val();
                var isnull = outstorage != null && store != null && buyStorage != null;
                var isempty = outstorage != "" && store != "" && buyStorage != "";
                var isundefin = outstorage != undefined && store != undefined && buyStorage != undefined;
                if (isundefin && isnull && isempty) {
                    $("#left_content").css("z-index", 0);
                    allEnabled();
                } else {
                    allDisabled();
                }
            });

            $(".pro_coun input").blur(function() {
                var va = $(this).val();
                var cou = $(this).parents("td").prev("td").text();
                if (va > cou) {
                    $(this).val(cou);
                    $.whiskey.web.alert("采购的数量不能超过总库存数");
                }
            });
            var stoId = $("#StoreID option:selected").val();
            storeWithStorage(stoId);
            $("#StoreID").change(function () {
                var storeId = $(this).val();
                storeWithStorage(storeId);
            });
            $("#StorageId").change(function() {
                var purid = $("#hid_da_pur").val();
                if (purid != "") return;

                var buystora = $("#BuyStorageID option:selected").val();
                var outstora = $("#StorageId option:selected").val();
                if (buystora == outstora) {
                    $("#BuyStorageID").children("option").removeAttr("disabled");
                    $("#BuyStorageID").children("option[value='" + outstora + "']").prop("disabled", true).prop("selected", false);
                } else {
                    $("#BuyStorageID").children("option").removeAttr("disabled");
                }
            });
            $("body").delegate(".checked-all", "click", function() {
                var stat = $(this).prop("checked");
                $(".te_1_che").prop("checked", stat);
            }).delegate(":button[title='删除']", "click", function() {
                var obj = this;
                var t = $.whiskey.web.ajaxConfirm({
                    question: "确认要移除这件商品吗？",
                    notes: "提示：此操作会将商品从服务器缓存中移除",
                    success_event: function() {
                        $(obj).parents("tr").remove();
                        var _id = $(obj).parents("tr").children("td:first").find(":checkbox").val();
                        var hid = $(obj).parents("tr").children("td:first").find("input[type='hidden']").val(); //采购单明细
                        if (hid != undefined && hid != "")
                            _id = hid;
                        removeRow(_id);

                    },
                    complete: function() {
                        //$.whiskey.datatable.reset(true);
                    }
                });

            }).delegate(":button[title='预览']", "click", function() {
                var id = $(this).parents("td").prevAll("td:last").children().children(":checkbox").val();
                var view = new $.whiskey.web.ajaxView({
                    caption: "详细信息",
                    actionUrl: "/Products/Product/View",
                    params: { Id: id },
                    lockButton: $(this),
                });

            });

            $("#RemoveAll").on("click", function() {
                var list = $.whiskey.web.getIdByChecked(".table-list .te_1_che:checked");
                if (list.length > 0) {

                    var confirm = new $.whiskey.web.ajaxConfirm({
                        question: "确认要移除这些商品吗？",
                        notes: "提示：此操作会将商品从服务器缓存中移除",
                        success_event: function() {
                            var ids = [];
                            $.each(list, function(i, v) {
                                var id = v.value;
                                if (id != "")
                                    ids.push(id);
                            });
                            $.post("@Url.Action("Remove")", { ids: ids, uuid: _guid }, function(da) {
                                if(da.ResultType==3)   $.whiskey.datatable.reset(false);
                            });
                        },
                    });
                } else {
                    $.whiskey.web.alert({
                        type: "info",
                        content: "请至少选择一条数据！",
                        callback: function() {
                        }
                    });
                }
            });
            //配货完成
            $("#Create").click(function() {
                var purchaseNumber=$("#hid_da_pur").val();
                var confirm = new $.whiskey.web.ajaxConfirm({
                    question: "确认配货？",
                    notes: "提示：配货完成后，不能修改",
                    actionUrl: "@Url.Action("Create")",
                    params:{PurchaseNumber:purchaseNumber},
                    complete: function () {
                        $.whiskey.web.load({ url: "@Url.Action("Index", "Purchase")" });
                        //$.whiskey.datatable.reset(false);
                    }
               });
            });
            //查看无效列表
            $(".scan-invalid").click(function() {
                if ($(".scan-invalid-count").text() == "0") {
                    $.whiskey.web.alert({
                        type: "info",
                        content: "无效数量为0！",
                        callback: function() {
                        }
                    });
                    return false;
                }
                $.whiskey.tools.other("0");
                showValid();
                return false;
            });
            //查看有效列表
            $(".scan-valid").click(function() {
                if ($(".scan-valid-count").text() == "0") {
                    $.whiskey.web.alert({
                        type: "info",
                        content: "有效数量为0！",
                        callback: function() {
                        }
                    });
                    return false;
                }
                $.whiskey.tools.other("1");
                showValid(this);
                return false;
            })

            //批量导入，
            $("#selec_prodBatch_list").click(function() {
                var dialog = new $.whiskey.web.ajaxDialog({
                    caption: "批量导入",
                    successTit: "确定",
                    successEvent: select_check_Access,
                    actionUrl: "/Warehouses/Buy/BatchImport",
                    noneheader: true,
                    lockButton: $(this),
                    methType: "post",
                    //uploadUrl: "/Warehouses/AddProduct/ExcelFileUpload",
                    formValidator: function() {
                        var $form = $(".modal-form");
                        if (!$form.valid()) {
                            $(".modal-dialog").parent("div").animate({ scrollTop: 20 }, 500);
                            return false;
                        } else {
                            return true;
                        }
                    },
                    postComplete: function() {
                        // $.whiskey.datatable.reset(false);
                        return true;
                    },
                });

            });
            //在弹出层中选择商品
            $("#selec_prod_list").click(function() {
                var dialog = new $.whiskey.web.ajaxDialog({
                    caption: "选择商品",
                    successTit: "确定",
                    className: "box-dg",
                    actionUrl: "/Warehouses/Buy/BuyProductSelect",
                    noneheader: true,
                    successEvent: function() {
                        getAllCheck();
                    },
                    lockButton: $(this),
                    formValidator: function() {
                        var $form = $(".modal-form");
                        if (!$form.valid()) {
                            $(".modal-dialog").parent("div").animate({ scrollTop: 20 }, 500);
                            return false;
                        } else {
                            return true;
                        }
                    },
                    postComplete: function() {
                        $.whiskey.datatable.reset(false);
                        return true;
                    },
                });

            });

            //每隔1s取一次数据校验
            setInterval(function() {
                sendToQueue();

            }, 1000);
        });
        //禁用扫描框以及子元素
        function allDisabled() {
            var purid = $("#hid_da_pur").val();
            if (purid != "") {
                //$("#Create").attr("disabled", "disabled");
                $("#RemoveAll").removeAttr("disabled");
                //$("#StoreID").attr("disabled", "disabled").css("background-color", "#dddddd");
                //$("#BuyStorageID").attr("disabled", "disabled").css("background-color", "#dddddd");
                $("#Notes").val("修改采购单，时间：" + new Date().toLocaleString());
                var setting = $.whiskey.datatable.instance.fnSettings();
                setting.sDom = "t<'F clearfix datatable-footer'<'col-md-2'l><'col-md-3'f>r<'col-md-7 text-right'p>>";
                setting.sAjaxSource = "/Warehouses/Purchase/GetPruListByNum?num=" + purid;
                $.whiskey.datatable.instance.fnSettings(setting);
                $.whiskey.datatable.instance.fnDraw(false);
                return;
            }
            $(".dataTables_processing").removeClass("dataTables_processing").html("");
            $("#left_content").addClass("disable_all_conte");
            $("#left_content div").attr("disabled", "disabled");
            $("#left_content input").attr("disabled", "disabled").addClass("disable_all_aOrlab");
            $("#left_content label").attr("disabled", "disabled").addClass("disable_all_aOrlab");
            $("#left_content a").attr("disabled", "disabled").removeAttr("href").addClass("disable_all_aOrlab");
            $(".valid").removeClass("scan-valid");
            $(".invalid").removeClass("scan-invalid");
            $("#left_content i").attr("disabled", "disabled");


        }
        //获取有效和无效数量
        function getValidAndInvalidCount() {
            $.post("/Warehouses/Buy/GetValidCount", { PurchaseNumber: "@ViewBag._purnum" }, function (da) {
                if (da) {
                    $(".scan-valid-count").text(da.valid);
                    $(".scan-invalid-count").text(da.invalid);
                    $("#Create").prop("disabled", da.valid == 0);
                }
            });
        }

        //启用扫描框以及子元素
        function allEnabled() {
            $("#left_content").removeClass("disable_all_conte").attr("title", "");
            $("#left_content div").removeAttr("disabled");
            $("#left_content label").removeAttr("disabled").removeClass("disable_all_aOrlab");
            $("#left_content i").removeAttr("disabled");
            $("#left_content a").removeAttr("disabled").attr("href", "#").removeClass("disable_all_aOrlab");
            $("#left_content input").removeAttr("disabled").removeClass("disable_all_aOrlab");
            $(".valid").addClass("scan-valid");
            $(".invalid").addClass("scan-invalid");
        }

        function storeWithStorage(storeId) {
            if (!storeId) return;

            var outstorage = $("#StorageId option:selected").val();
            $.post("/Warehouses/Storage/GetStorages", { storeId: storeId }, function (da) {
                var opts = "<option value=''>-选择仓库-</option>";
                if (da != null && da != "") {
                    opts = "";
                    $.each(da, function (ind, item) {
                        if (item.Value != outstorage) {
                            opts += "<option value=\"" + item.Value + "\"" + (ind == 1 ? " selected='selected'" : "") + ">" + item.Text + "</option>";
                        } else {
                            opts += "<option value=\"" + item.Value + "\" disabled>" + item.Text + "</option>";
                        }
                    });
                }
                $("#BuyStorageID").html("").html(opts);
                 $('#BuyStorageID').selectpicker("refresh");
      			 $('#BuyStorageID').selectpicker("render");
            });
        }

        //创建采购单
        function createBuy() {
            //$("#Create").attr("disabled", "disabled");
            //修改采购单
            var _num = $("#hid_da_pur").val();
            var pur = "";
            if (_num != undefined && _num != null && _num != "") {
                updatePurch();
                return;
            }
            //否则 创建采购单
            var outStorageId = $("#StorageId option:selected").val();
            var InStoreID = $("#StoreID option:selected").val();
            var InStorage = $("#BuyStorageID option:selected").val();
            var InDate = $("#CreateTime").val();
            if (InDate == null || InDate == "")
                InDate = getDatetime();
            var description = $("#Notes").val();

            var checoun = $(".te_1_che:checked");
            buyIds = [];
            if (checoun != null && checoun.length > 0) {

                //创建采购单
                $.post("/Warehouses/Buy/Create", {
                    outStorageId: outStorageId,
                    InStoreID: InStoreID,
                    InStorage: InStorage,
                    InDate: InDate,
                    description: description,
                    uuid:_guid
                }, function(da) {
                    if (da.ResultType == 3) {
                        $.whiskey.web.alert({
                            type: "success",
                            par: { keyboard: false, backdrop: "static" },
                            content: "采购单创建成功，并且采购信息已经保存",
                            callback: function() {
                                $("tbody tr").remove();
                                $.whiskey.tools.arraylist.other(0);
                                $.whiskey.web.load({url:'/Warehouses/Purchase/Index'})
                              //  location.href = "/Warehouses/Purchase/Index";
                            }
                        });
                    } else {
                        $.whiskey.web.alert({
                            type: "warning",
                            content: "采购单创建失败",
                            callback: function() {
                                //$("#Create").removeAttr("disabled");
                            }

                        });
                    }
                });
            } else {
                ////////////////////////////////////////

            }

        }

        //修改采购单
        function updatePurch() {
            var _num = $("#hid_da_pur").val();
            var checoun = $(".te_1_che:checked");
            buyIds = [];
            if (checoun != null && checoun.length > 0) {

                for (var i = 0; i < checoun.length; i++) {
                    var puritem = $(checoun[i]).parents("tr").first().find("input[type='hidden']"); //采购明细ID
                    var puritemId = "";
                    if (puritem != undefined && puritem != null)
                        puritemId = puritem.val();
                    var _id = $(checoun[i]).val(); //商品编号
                    var _count = $($(checoun[i]).parents("td").nextAll().not(":last").last().children("input")[0]).val(); //采购数量
                    var _count1 = $($(checoun[i]).parents("td").nextAll().not(":last").not(":last").last()).text(); //库存数
                    if (parseInt(_count) > parseInt(_count1)) {
                        $.whiskey.web.alert({
                            type: "warning",
                            content: "采购数量不能大于库存数"
                        });
                        $(checoun[i]).parents("td").nextAll().not(":last").last().addClass("has-error");
                        return false;
                    } else {
                        $(checoun[i]).parents("td").nextAll().not(":last").last().removeClass("has-error");
                        buyIds.push($.param({ Id: _id, Cou: _count, pitemId: puritemId }));
                    }

                }
            }
            $.post("/Warehouses/Buy/UpdatePurchase", {
                purId: _num,
                data: buyIds.join(","),

            }, function(da) {
                if (da.ResultType == 3 || da.ResultType == 2) {
                    $.whiskey.web.alert({
                        type: "success",
                        par: { keyboard: false, backdrop: "static" },
                        content: "采购单修改成功，并且采购信息已经保存",
                        callback: function() {
                            $.whiskey.tools.arraylist.clear();
                            $.whiskey.tools.arraylist.other(0);
                            $.whiskey.web.load({url:"/Warehouses/Purchase/Index"})
                           // location.href = "/Warehouses/Purchase/Index";
                        }
                    });
                } else {
                    $.whiskey.web.alert({
                        type: "warning",
                        content: "采购单修改失败",
                        callback: function() {
                            //$("#Create").removeAttr("disabled");
                        }
                    });
                }
            });
        }

        function removeRow(proIdList) {
            //ids:"12,2,4"
            var purnum = $("#hid_da_pur").val();

            if (proIdList == undefined || proIdList == null || proIdList == "")
                return false;
            var regex = /^[,\d]+$/;
            if (regex.test(proIdList)) {
                $.post("/Warehouses/Buy/Remove", { ids: proIdList, purnum: purnum }, function(da) {
                    if (da.ResultType == 3) {
                        $.whiskey.web.alert({
                            type: "success",
                            content: "删除成功",
                            callback: function() {
                                $.whiskey.tools.arraylist.other(1); //标记为已修改
                                //$("#Create").removeAttr("disabled");
                            }
                        });
                    } else {
                        $.whiskey.web.alert({
                            type: "warning",
                            content: "删除失败"
                        });
                    }
                })
            }

        }

        //将队列中的数据发往服务端验证
        function sendToQueue() {
            if (hashlist.size() > 0) {
                $("#Create").prop("disabled", true);
                //$("#RemoveAll").attr("disabled", "disabled");
                //采购单编号
                var hid_da_pur = $("#hid_da_pur").val();

                var globalUUID = hashlist.getFirst(0);
                var scanNumber = hashlist.getFirst(1);
                var StorageId = $("#StorageId option:selected").val();
                var exist = 0;
                $("#DataTables_Table_0 .dt_num").each(function() {
                    if ($(this).html().trim() == scanNumber)
                        exist = 1;
                });
                // var status = $.whiskey.tools.status(); //标记当前状态是采购还是入库
                $.ajax({
                    type: "POST",
                    data: { uuid: globalUUID, number: scanNumber, StorageId: StorageId, guid: _guid,PurchaseNumber:hid_da_pur },
                    async: false,
                    url: "/Warehouses/Buy/AddToScan",
                    success: function(data) {
                        //是否存在已配货商品
                        var isReady = data.Data.isReady;
                        $("#Create").prop("disabled", isReady == false);
                        hashlist.remove(data.Data.uuid);

                        $(".scan-queue-count").animate({
                            opacity: "0.3",
                        }, 'slow', function() {
                            $(".scan-queue-count").animate({
                                opacity: "1.0",
                            }, 'fast', function() {
                                $(".scan-queue-count").text(hashlist.size());
                            });
                        });
                        if ($(".scan-valid-count").text() != data.Data.validCou) {
                            $(".scan-valid-count").animate({
                                opacity: "0.3",
                            }, 'slow', function() {
                                $(".scan-valid-count").animate({
                                    opacity: "1.0",
                                }, 'fast', function() {
                                    $(".scan-valid-count").text(data.Data.validCou);
                                });
                            });
                        }
                        if ($(".scan-invalid-count").text() != data.Data.invalidCou) {
                            $(".scan-invalid-count").animate({
                                opacity: "0.3",
                            }, 'slow', function() {
                                $(".scan-invalid-count").animate({
                                    opacity: "1.0",
                                }, 'fast', function() {
                                    $(".scan-invalid-count").text(data.Data.invalidCou);
                                });
                            });
                        }
                        if (data.ResultType == 3) {
                            $.whiskey.datatable.reset(false);
                        }
                    }
                });
            } else {
                var purnum = $("#hid_da_pur").val();
                if (purnum != "") {
                    //修改

                } else {
                    $("#Create").prop("disabled", false);
                    //$("#RemoveAll").removeAttr("disabled");
                }
            }
        }

        //动态添加一行
        function addRows(da) {

            var jsonda = $.parseJSON(da);
            if (jsonda != undefined && jsonda != null) {
                var res = "";
                var rowcou = $($.whiskey.datatable.instance[0]).children("tbody").find("tr").length;

                res += "<tr class='dt_row'><td class='dt_td dt_ch'>" + $.whiskey.datatable.tplListCheckbox(jsonda.Id) + "</td>><td class='dt_td dt_num'>" + (rowcou + 1) + "</td><td class='dt_td dt_num'>" + jsonda.ProductNumber + "</td><td class='dt_td'>" + jsonda.ProductName + "</td>";
                var pnum = $("#hid_da_pur").val();
                if (pnum != "") {
                    var ind = rowcou + 1;
                    $.whiskey.tools.arraylist.add(ind);
                }
                res += "<td class='dt_td'>" + jsonda.Brand + "</td><td class='dt_td'>" + jsonda.Size + "</td>";
                res += "<td class='dt_td'>" + jsonda.Season + "</td><td class='dt_td'>" + jsonda.Color + "</td>"

                var purnum = $("#hid_da_pur").val();
                if (purnum != null && purnum != "") {
                    res += "<td class='dt_td'><img style='float:center' class='col-md-5 img-thumbnail img-responsive' src='" + jsonda.Thumbnail + "'/></td>";
                } else {
                    res += "<td class='dt_td'><img class='img-thumbnail img-responsive' src='" + jsonda.Thumbnail + "'/></td>";
                }
                res += "<td class='dt_td'>" + jsonda.WholesalePrice + "</td><td>" + jsonda.Amount + "</td><td class='dt_td pro_coun'><input style='width:100%' type='number' value='1' min='0' max='" + jsonda.Amount + "' title='采购数量不能小于1件' class='form-control'></td>";

                res += "<td class='dt_td' style='width:15%'>" + deleDat("移除") + review() + "</td>"
                res += "</tr>";

                $($.whiskey.datatable.instance[0]).children("tbody").append(res);
                $.whiskey.tools.arraylist.other(1); //标记为已修改
                //$("#Create").removeAttr("disabled");
            }

        }

        //更改采购数量
        function updateCoun(numb) {
            $("#DataTables_Table_0 .dt_num").each(function() {
                var num = $(this).html().trim();
                if (num == numb) {
                    var co = $(this).parents("tr").children(".pro_coun").children("input");
                    var sourCou = parseInt($(co).val().trim()) + 1;
                    $(co).val(sourCou);

                }
            });
        }

        //显示有效和无效列表
        function showValid(send) {
            var hid_da_pur = $("#hid_da_pur").val();
            var dialog = new $.whiskey.web.ajaxView({
                type:"post",
                caption: "查看列表",
                actionUrl: "/Warehouses/Buy/GetValidList",
                params: { PurchaseNumber: hid_da_pur },
                lockButton: $(send),
            });
        }

        //在弹出层中当勾选了复选框，单击“确定”时触发
        function getAllCheck() {

            var checks = $(".pdl:checked");
            if (checks.length == 0) {
                //$.whiskey.web.alert({
                //    type: "info",
                //    content: "请勾选需要采购的商品",
                //    callback: function () {
                //        return false;
                //    }
                //});
                //alert("hi");
                //return false;

            } else {
                for (var i = 0; i < checks.length; i++) {
                    // var _id = $(checks[i]).val();
                    var num = $(checks[i]).parents("td").nextAll("td").eq(1).html();
                    EnterQue(num);
                }
            }
        }

        //将批量导入中选中的元素压入队列
        function select_check_Access() {
            //$(".td_lef:checked").each(function() {
            //    EnterQue($(this).val());
            //});
            //采购单编号
            var hid_da_pur = $("#hid_da_pur").val();
            var StorageId = $("#StorageId option:selected").val();

            $.post("@Url.Action("ExcelBatchStrageCheck")", { PurchaseNumber: hid_da_pur, StorageId: StorageId }, function (data) {
                //是否存在已配货商品
                var isReady =data.Data.isReady;
                $("#Create").prop("disabled", isReady == false);
                //hashlist.remove(data.Data.uuid);

                $(".scan-queue-count").animate({
                    opacity: "0.3",
                }, 'slow', function() {
                    $(".scan-queue-count").animate({
                        opacity: "1.0",
                    }, 'fast', function() {
                        $(".scan-queue-count").text(hashlist.size());
                    });
                });
                if ($(".scan-valid-count").text() != data.Data.validCou) {
                    $(".scan-valid-count").animate({
                        opacity: "0.3",
                    }, 'slow', function() {
                        $(".scan-valid-count").animate({
                            opacity: "1.0",
                        }, 'fast', function() {
                            $(".scan-valid-count").text(data.Data.validCou);
                        });
                    });
                }
                if ($(".scan-invalid-count").text() != data.Data.invalidCou) {
                    $(".scan-invalid-count").animate({
                        opacity: "0.3",
                    }, 'slow', function() {
                        $(".scan-invalid-count").animate({
                            opacity: "1.0",
                        }, 'fast', function() {
                            $(".scan-invalid-count").text(data.Data.invalidCou);
                        });
                    });
                }
                if (data.ResultType == 3) {
                    $.whiskey.datatable.reset(false);
                }
            });
        }

        //将数据压入队列
        function EnterQue(scanNumber) {
            if (scanNumber.length > 0) {
                var barcodeArr = scanNumber.split(',');
                if (barcodeArr.length <= 0) {
                    return;
                }
                barcodeArr.forEach(function (value, index, arr) {
                    var uuid = $.whiskey.tools.UUID(32, 16);
                    hashlist.put(uuid, value);
                    $(".scan-queue-count").text(hashlist.size());
                    $(".scan-number").val("");
                    $(".scan-number").focus();
                });

            }
        }

    </script>
    <script>
    // cur_selectpicker 初始化
    $(function () {
        $('.cur_selectpicker').selectpicker();
        $('.cur_selectpicker').selectpicker("refresh");
        $('.cur_selectpicker').selectpicker("render");
    })
</script>
}