@*@Html.FilePathAppendMd5("/Content/Styles/Layout/admin.css")*@
@Html.CssBlock("/Content/Styles/Layout/admin.css") 
@Html.CssBlock("/Content/Scripts/city/citySelect.css") 
<link rel="stylesheet" href="/Content/Styles/swiper/swiper.css" />
<!--<link rel="stylesheet" href="/Content/Styles/Cropper/cropper.min.css" />
<script src="/Content/Scripts/Cropper/cropper.min.js"></script>-->
<script src="/Content/Scripts/swiper/swiper.min.js"></script>
<script src="/Content/Scripts/vue/vue.min.js"></script>
<div class="rt_content1" id="vueContent" v-cloak>
	<div class="userPhotoBox">
		<div class="userPhotoEdit">
			<img src="/Content/Images/information/editPhoto.png" />
			<div class="editPhotoText">修改头像</div>
		</div>
		<canvas id="empirical"></canvas>
		<img src="@ViewBag.MemberPhoto" class="userPhoto memberPhoto" />
	</div>
	<div class="contentbox">
		<div class="content-menu">
			<div class="content-menu-title activeMenuTitle" data-content="information-content">个人信息</div>
			<div class="content-menu-title informationEdit" data-content="edit-content">编辑</div>
			<div class="content-member">{{ userInfo.MemberTypeName }}</div>
			<div class="editSaveBtn">保存</div>
		</div>
		<div class="content">
			<div class="main_content information-content">
				<div class="contentScroll">
					<div class="tableList">
						<div class="tableRow">
							<div class="tableCell">昵称</div>
							<div class="tableCell">{{ userInfo.MemberName }}</div>
						</div>
						<div class="tableRow">
							<div class="tableCell">真实姓名</div>
							<div class="tableCell">{{ userInfo.RealName?userInfo.RealName:'未填写' }}</div>
						</div>
						<div class="tableRow">
							<div class="tableCell">性别</div>
							<div class="tableCell">{{ userInfo.Gender?'男':'女' }}</div>
						</div>
						<div class="tableRow">
							<div class="tableCell">注册日期</div>
							<div class="tableCell">{{ userInfo.DateofBirth }}</div>
						</div>
						<div class="tableRow">
							<div class="tableCell">邮箱</div>
							<div class="tableCell">{{ userInfo.Email?userInfo.Email:'未填写' }}</div>
						</div>
						<div class="tableRow">
							<div class="tableCell">手机号</div>
							<div class="tableCell">{{ userInfo.MobilePhone }}</div>
						</div>
						<div class="tableRow">
							<div class="tableCell">归属店铺</div>
							<div class="tableCell StoreName">{{ userInfo.StoreName }}</div>
							<img class="editStore" src="/Content/Images/information/editStore.png" />
						</div>
					</div>
				</div>
			</div>
			<div class="main_content edit-content">
				<div class="contentScroll">
					<div class="admin_content">
						<div class="clearfix admin_detail">
							<div class="admin_left">昵称</div>
							<input type="text" class="admin_right editMemberName" :value="userInfo.MemberName" />
						</div>
						<div class="clearfix admin_detail">
							<div class="admin_left">真实姓名</div>
							<input type="text" class="admin_right editRealName" :value="userInfo.RealName" />
						</div>
						<div class="clearfix admin_detail">
							<div class="admin_left">性别</div>
							<div class="admin_sex"><label for="man">男</label><input id="man" v-model="userInfo.Gender" type="radio" value="1" name="editGender" /></div>
							<div class="admin_sex"><label for="women">女</label><input id="women" v-model="userInfo.Gender" type="radio" value="0" name="editGender" /></div>
						</div>
						<div class="clearfix admin_detail">
							<div class="admin_left">邮箱</div>
							<input type="text" class="admin_right editEmail" :value="userInfo.Email" />
						</div>
						<div class="clearfix admin_detail">
							<div class="admin_left">原始密码</div>
							<input type="password" class="admin_right editOldPassword" />
						</div>
						<div class="clearfix admin_detail">
							<div class="admin_left">新密码</div>
							<input type="password" class="admin_right editNewPassword" />
						</div>
						<div class="clearfix admin_detail">
							<div class="admin_left">确认新密码</div>
							<input type="password" class="admin_right editSurePassword" />
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="storeList">

		<div class="close_store_btn">
			<img src="data:image/png;base64,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" />
		</div>
		<p class="storeTitle">店铺列表</p>
		<div class="swiper-container">
			<div class="swiper-wrapper">
				<!--<div class="swiper-slide">
					<ul class="storeListBox">
						<li class="store-head store-tr">
							<div class="store-td">编号</div>
							<div class="store-td">店铺名称</div>
							<div class="store-td">类型</div>
							<div class="store-td">选择</div>
						</li>
						<li class="store-tr">
							<div class="store-td">1</div>
							<div class="store-td">风雅店</div>
							<div class="store-td">直营店</div>
							<div class="store-td"><input type="radio" name="storeSelect" /></div>
						</li>
					</ul>
				</div>-->
			</div>
		</div>
		<div class="totalCount">共<span class="storeTotal">0</span>条</div>
		<div class="storeListFooter">
			<button class="editStoreButton">修改</button>
			<p><span class="point">*</span>修改店铺后，积分归零，储值不变</p>
		</div>
		<div class="storePage">
			<div class="swiper-button-prev swiper-button-black"></div>
			<div class="swiper-button-next swiper-button-black"></div>
			<span>第<b id="curentpage">1</b>/<b class="totaPage">1</b>页</span>
			<span>提示：左右拖拽翻页</span>
		</div>
	</div>
</div>

<script>

			//获取用户信息
		var content = new Vue({
			el:'#vueContent',
			data :{
				userInfo : {}
			}
		})
		
		$.ajax({
			type:"post",
			url:"/Members/Member/GetMemberInfo",
			dataType:'json',
			data:{},
			success:function(data){
				if( data.ResultType == 3 ){
					var data = data.Data;
					content.userInfo = data;
				}
			}
		});
		
		//	//初始化滚动条
		$(".rt_content1 .main_content").panel({
			iWheelStep: 20
		});
		$('.content-menu-title').click(function() {
			$('.activeMenuTitle').removeClass('activeMenuTitle');
			$(this).addClass('activeMenuTitle');
			var this_content = $(this).attr('data-content');
			$('.main_content').hide();
			$('.' + this_content).show();
			if($(this).hasClass('informationEdit')) {
				$('.informationEdit').hide()
				$('.userPhotoEdit,.editSaveBtn').show()
			} else {
				$('.informationEdit').show()
				$('.userPhotoEdit,.editSaveBtn').hide()
			}
		})
		
	
	var StoreListMaxPage = 9999;
	var initPage = 0;
		
	
	
//------------------------------------------------------------------------经验值
	var canvas = document.getElementById('empirical');
	var cW = 190;
	canvas.width = cW;
	canvas.height = cW;
	animateArc(canvas);
	function animateArc(canvas) {
		var paintBrush = canvas.getContext('2d');
		var init = Math.PI;
		var start = Math.PI;
		var end = Math.PI * 2.5;
		var timer = setInterval(function() {
			start += 0.1;
			if(start >= end) {
				clearInterval(timer)
			}
			paintBrush.clearRect(0, 0, 190, 190)
			paintBrush.beginPath();
			paintBrush.lineCap = "round";
			paintBrush.lineWidth = 5;
			paintBrush.strokeStyle = 'rgba(255,255,255,1)';
			paintBrush.arc(cW / 2, cW / 2, cW / 2, init, start, false);
			paintBrush.stroke();
			paintBrush.closePath();
		}, 20)
	}
//----------------------------------------------------------------------获取店铺列表	
		$('.editStore').click(function() {
			GetStoreList();
			GetStoreList();
			$('.storeList').fadeIn()
		})
		$('.close_store_btn').click(function() {
			$('.storeList').fadeOut();
		})
	function GetStoreList(){
		if( initPage >= StoreListMaxPage )return;
		initPage++;
		$.ajax({
			type:"post",
			url:"/Members/Member/GetStoreList",
			dataType:'json',
			data:{
				PageIndex :initPage,
				PageSize : 10
			},
			success:function(data){
//				console.log(data)
				var swiperSlide = $('<div class="swiper-slide"><ul class="storeListBox"><li class="store-head store-tr"><div class="store-td">编号</div><div class="store-td">店铺名称</div><div class="store-td">类型</div><div class="store-td">选择</div></li></ul></div>')
				var html = '';
				$(data.Data.result).each(function(i,item){
					html+= '<li class="store-tr"><div class="store-td">'+ item.StoreId +'</div><div class="store-td selectStore">'+ item.StoreName +'</div><div class="store-td">'+ item.TypeName +'</div><div class="store-td"><input type="radio" value='+ item.StoreId +' name="storeSelect" /></div></li>'
				})
				$('.storeTotal').html(data.Data.total)
				StoreListMaxPage = data.Data.totaPage;
				$('.totaPage').html(data.Data.totaPage)
				$(swiperSlide).find('.storeListBox').append(html)
				$('.storeList .swiper-wrapper').append(swiperSlide)
			}
		});
	}
	
	var mySwiper = new Swiper('.swiper-container', {
		// 如果需要前进后退按钮
		nextButton: '.swiper-button-next',
		prevButton: '.swiper-button-prev',
		onSlideChangeEnd: function(swiper) {
			$('#curentpage').text(swiper.activeIndex + 1) //切换结束时，告诉我现在是第几个slide
			
			if( $('.storeList .swiper-wrapper .swiper-slide').length == swiper.activeIndex + 1 ){
				GetStoreList()
			}
		},
		observer: true,
		observeParents: true,
	})


	//--------------------------------------------------------------------------修改店铺
	$('.editStoreButton').click(function(){
		
		var selectStoreId = $('input[name="storeSelect"]:checked').val();
		var selectName = $('input[name="storeSelect"]:checked').parents('.store-tr').find('.selectStore').text()
		if( !selectStoreId ){
			layer.msg("请选择修改店铺",{'icon':2})
		}else{
			updateStore(parseInt(selectStoreId),selectName)
			$('.storeList').fadeOut();
		}
	})
	
	function updateStore(selectStoreId,selectName){
		$.ajax({
			url:'UpdateStore',
			type:'post',
			data:{
				StoreId:selectStoreId
			},
			success:function(data){
				if( data.ResultType == 3 ){
					layer.msg(data.Message,{'icon':1})
					$('.StoreName').text(selectName)
				}else{
					layer.msg(data.Message,{'icon':2})
				}
			}
		})
	}
	//--------------------------------------------------------------------------修改会员信息
	//保存编辑
	$('.content-menu').on('click', '.editSaveBtn', function() {
		updateUserInfo()
	})
	function updateUserInfo(){
		var memberInfo = checkUserInfo();
		if( !memberInfo ) return;
		$.ajax({
			"url":'UpdateInfo',
			type:'post',
			data:{
				memberInfo : memberInfo
			},
			success:function(data){
				if( data.ResultType == 3 ){
					layer.msg(data.Message,{'icon':1})
					setTimeout(function(){$('.userInfoMenu').click()},1500)
				}else{
					layer.msg(data.Message,{'icon':2})
				}


			}
		})
	}
	function checkUserInfo(){
		var memberInfo,MemberName,RealName,Gender,Email,MemberPass,ResetPass,SecondReset;
		MemberName = $('.editMemberName').val();
		RealName = $('.editRealName').val();
		Gender = $('input[name=editGender]:checked').val();
		Email = $('.editEmail').val();
		MemberPass = $('.editOldPassword').val();
		ResetPass = $('.editNewPassword').val();
		SecondReset = $('.editSurePassword').val();
		if( !MemberName.trim() ){
			layer.msg('请填写用户昵称',{'icon':2})
		}
		else if( !RealName.trim() ){
			layer.msg('请填写真实姓名',{'icon':2})
		}
		else if( Gender == undefined ){
			layer.msg('请选择性别',{'icon':2})
		}
		else if( !Email.trim() ){
			layer.msg('请填写邮箱',{'icon':2})
		}
		else if( MemberPass ){
			if( !ResetPass ){
				layer.msg('请填写新密码',{'icon':2})
				return;
			}else{
				if(!SecondReset){
					layer.msg('请填确认新密码',{'icon':2})
					return;
				}
			}
			memberInfo = {
				"MemberName":MemberName,
				"RealName":RealName,
				"Gender":Gender,
				"Email":Email,
				"MemberPass":MemberPass,
				"ResetPass":ResetPass,
				"SecondReset":SecondReset
			};
			return memberInfo
		}else{
			memberInfo = {
				"MemberName":MemberName,
				"RealName":RealName,
				"Gender":Gender,
				"Email":Email,
			};
			return memberInfo
		}
	}
	//--------------------------------------------------------------------------图片裁剪
	upImg();
	var blob;
	function upImg() {
		$(".userPhotoEdit").on("click", function() {
			$('body').append('<div class="parsetcroBox"><div class="cropperBox"><img class="closeCropper" src="data:image/png;base64,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"  /><h4 class="boxH4">图片裁剪 <a class="imgBoxBtn">选择图片 <input type="file" class="file_upload" /></a></h4><div class="imgBox"><img id="preview" src="" /></div><div class="imgBoxyulan"><img id="previewyulan" src="" /></div><div class="bottomBox"><button class="imgBoxBtn Determine">确定</button><button class="imgBoxBtn xuanzhuan">旋转</button></div></button></div></div>')

			//$(".parsetcroBox").fadeIn(500)
		})
		$('body').on('click','.closeCropper',function() {
			$('.parsetcroBox').remove()
		})
		//将选择的图片在裁剪区域显示出来
		$("body").on("change", ".file_upload", function() {
			var $file = $(this);
			var fileObj = $file[0];
			var windowURL = window.URL || window.webkitURL;
			var dataURL;
			var $img = $("#preview");
			if(fileObj && fileObj.files && fileObj.files[0]) {
				dataURL = windowURL.createObjectURL(fileObj.files[0]);
				$img.attr('src', dataURL);
			} else {
				dataURL = $file.val();
				var imgObj = document.getElementById("preview");
				imgObj.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
				imgObj.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = dataURL;

			}
			$img.cropper({
				aspectRatio: 1 / 1,  //图片比例,1:1
				crop: function(data) {
					var $imgData = $img.cropper('getCroppedCanvas')
					var dataurl = $imgData.toDataURL('image/png');
					$("#previewyulan").attr("src", dataurl)
				},
				built: function(e) {}
			});
			//	console.log(dataURL)
			$img.cropper('replace', dataURL)
			//旋转
			$(".xuanzhuan").on("click", function() {
				$img.cropper('rotate', 90)
			})
			//关闭剪裁层并上传
			$('.Determine').click(function() {
				var $imgData = $img.cropper('getCroppedCanvas')
				var dataurl = $imgData.toDataURL('image/png'); //dataurl便是base64图片
				$(".memberPhoto").attr("src", dataurl);
				$(".parsetcroBox").fadeOut(1000)
				imgReplaceBtn = 1
				blob = dataURLtoBlob(dataurl); //将base64图片转化为blob文件方法
				uploadImage(blob)
			})

			function dataURLtoBlob(dataurl) { //将base64格式图片转换为文件形式
				var arr = dataurl.split(','),
					mime = arr[0].match(/:(.*?);/)[1],
					bstr = atob(arr[1]),
					n = bstr.length,
					u8arr = new Uint8Array(n);
				while(n--) {
					u8arr[n] = bstr.charCodeAt(n);
				}
				return new Blob([u8arr], {
					type: mime
				});
			}
		});

	}

	function uploadImage(file) {
		var actionUrl = "https://www.0-fashion.com/ApiMember/Upload";
		var userId = "@ViewBag.MemberId";
		var formData = new FormData();
		formData.append('MemberId', userId);
		formData.append("file", file);
		$.ajax({
			type: "POST", //提交类型
			dataType: "json", //返回结果格式
			url: actionUrl, //请求地址
			data: formData,
			processData: false, // 告诉jQuery不要去处理发送的数据
			contentType: false, // 告诉jQuery不要去设置Content-Type请求头
			success: function(data) {
				var userPhoto = data.Data;
				if(data.ResultType == 3) {
					$(".memberPhoto").attr("src", userPhoto);
					layer.msg(data.Message, {
						'icon': 1
					})
				} else {
					layer.msg(data.Message, {
						'icon': 2
					})
				}
			},
			error: function(xhr, type, errorThrown) {
				layer.msg('网络异常，请稍后再试！', {
					'icon': 2
				})
			}
		});
	}
	
	
</script>